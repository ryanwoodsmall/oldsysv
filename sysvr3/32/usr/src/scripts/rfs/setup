#ident	"@(#)pkg.rfs:rfs/setup	1.10.3.1"
# Install RFS "drivers"
#
DRVPATH=/boot
/etc/drvinstall -d $DRVPATH/du.o -v 1.0
/etc/drvinstall -d $DRVPATH/dufst.o -v 1.0
rm -f $DRVPATH/du.o
rm -f $DRVPATH/dufst.o
rm -f /usr/nserve/nspip

MAJOR=`/etc/drvinstall -d $DRVPATH/sp.o -c 32 -v 1.0`
touch /etc/system

M2=`/etc/drvinstall -d $DRVPATH/CLONE -nbv 1.0`

rm -rf $DRVPATH/sp.o
rm -rf /dev/spx
/etc/mknod /dev/spx c $M2 $MAJOR

if grep 'NSRMOUNT.* 0$' /etc/master.d/kernel >/dev/null 2>&1
then
	ed - /etc/master.d/kernel <<! >/dev/null 2>&1
	/^NSRMOUNT/s/ 0/ 50/
	w
	q
!
fi

/etc/mkboot -k /boot/KERNEL

if [ ! -d /etc/rc0.d ]
then
	mkdir /etc/rc0.d
fi

if [ ! -d /etc/rc2.d ]
then
	mkdir /etc/rc2.d
fi

if [ ! -d /etc/rc3.d ]
then
	mkdir /etc/rc3.d
fi

ln /etc/init.d/fumounts /etc/rc0.d/K50fumounts
ln /etc/init.d/rumounts /etc/rc0.d/K60rumounts
ln /etc/init.d/rfs      /etc/rc0.d/K65rfs

ln /etc/init.d/fumounts /etc/rc2.d/K30fumounts
ln /etc/init.d/rumounts /etc/rc2.d/K40rumounts
ln /etc/init.d/rfs      /etc/rc2.d/K50rfs

ln /etc/init.d/rfs      /etc/rc3.d/S21rfs

#
#	rfudaemon and rfuadmin have moved from /usr/bin to /usr/nserve
#

if [ -f /usr/bin/rfudaemon ]
then
	rm -f /usr/bin/rfudaemon
fi

if [ -f /usr/bin/rfuadmin ]
then
	mv /usr/bin/rfuadmin /usr/nserve/rfuadmin
fi

#
#	Do the idload(1M) command if it needs to be done...
#

if [ -f /usr/nserve/auth.info/uid.rules -a ! -f /usr/nserve/auth.info/.\<uid.rules\> ]
then
	idload >/dev/null 2>&1
fi


#
#	Initialize service codes for all installed transport providers
#

NLS=/usr/bin/nlsadmin

for n in `$NLS -x | sed 's/	.*$//'`
do
	$NLS -a 105 -c"/usr/net/servers/rfs/rfsetup" -y"RFS server" $n >/dev/null 2>&1
done

# set up cron entry for rmnttry polling
CRONDIR=/usr/spool/cron/crontabs
CRONTAB=/usr/spool/cron/crontabs/root
TEMPCRON=/usr/tmp/cron.$$

POLL='10,25,40,55 * * * * /usr/nserve/rmnttry >/dev/null'

if [ -d $CRONDIR ]; then
	if [ ! -f $CRONTAB ]; then
		> $CRONTAB
		chown root $CRONTAB 2>/dev/null
		chmod 644 $CRONTAB 2>/dev/null
	fi
else
	echo "** WARNING **  ${PKGNAME} cannot install crontab entry"
	echo "Daemon will not be running when installation is finished"
fi

if [ -f $CRONTAB ]; then
	if grep "rmnttry" $CRONTAB >/dev/null 2>&1 ; then :
	else
		crontab -l >$TEMPCRON 2>/dev/null
		echo "$POLL" >> $TEMPCRON
		crontab $TEMPCRON 2>/dev/null
		/bin/rm -f $TEMPCRON
	fi
fi
